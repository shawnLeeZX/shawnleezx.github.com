<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta content="Shawn" property="og:site_name">
  <link href="/favicon.png" rel="icon">

  
  <meta content="On Linux Laptop Battery" property="og:title">
  

  
  <meta content="article" property="og:type">
  

  
  <meta content="<h1>World Hacker's Notebook</h1>" property="og:description">
  

  
  <meta content="http://shawnLeeZX.github.io/blog/2015/09/07/on-linux-laptop-battery/" property="og:url">
  

  
  <meta content="2015-09-07T14:15:00+08:00" property="article:published_time">
  <meta content="http://shawnLeeZX.github.io/about/" property="article:author">
  

  <meta property="og:image" content="">

  
  
  <meta content="Linux" property="article:section">
  
  

  
  
  

  <title>On Linux Laptop Battery - Shawn</title>
  <meta name="description" content="I would like to note down the how to prolong battery life, in term of bothhours and years.Roughly, there are three tricks to extend battery time, laptop-mode...">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="/css/main.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <!-- Typesetting math using MathJax -->
  <!-- mathjax config similar to math.stackexchange -->
  <script type="text/x-mathjax-config">
   MathJax.Hub.Config({
     jax: ["input/TeX", "output/HTML-CSS"],
     tex2jax: {
       inlineMath: [ ['$', '$'] ],
       displayMath: [ ['$$', '$$']],
       processEscapes: true,
       skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
     },
     messageStyle: "none",
     "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
   });
  </script>
  <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="http://shawnLeeZX.github.io/blog/2015/09/07/on-linux-laptop-battery/">
  <link rel="alternate" type="application/rss+xml" title="Shawn" href="http://shawnLeeZX.github.io/feed.xml">
</head>

  <body>
    <section>
<nav class="navbar navbar-default navbar-fixed-top">

  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Shawn</a>
    </div>


    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="/about">About</a></li>
        <li><a href="/blog">Blog</a></li>
        <li><a href="/blog/archives">Archive</a></li>
      </ul>

    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
</section>

    <section>
      <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="page-title" itemprop="name headline">On Linux Laptop Battery</h1>
      <p class="post-meta"><time datetime="2015-09-07T14:15:00+08:00" itemprop="datePublished">Sep 7, 2015</time></p>
    </div>

</div>


  <div class="post-content container" itemprop="articleBody">
    <p>I would like to note down the how to prolong battery life, in term of both
hours and years.</p>

<p>Roughly, there are three tricks to extend battery time, <code class="highlighter-rouge">laptop-mode</code>,
<code class="highlighter-rouge">powertop</code> and changing screen lightness, and one trick to extend life,
stopping battery charging according to thresholds. The last trick is only
applicable to Thinkpad.</p>

<!-- more -->

<h2 id="extending-battery-time">Extending Battery Time</h2>

<p>I have three tricks for extending the battery time, <code class="highlighter-rouge">laptop_mode</code>, <code class="highlighter-rouge">powertop</code>
and setting the lightness of the screen. The exact number is forgotten, but
roughly if the original time of the laptop is around 4 hours, enabling
<code class="highlighter-rouge">laptop_mode</code> will get me one extra, <code class="highlighter-rouge">powertop</code> two extra and lightness one
extra.</p>

<p>Normally, people are told to use one battery management programs considering
that different programs may conflict, but I found <code class="highlighter-rouge">laptop_mode</code> works well with
<code class="highlighter-rouge">powertop</code>, a long time ago. So I settled with it.</p>

<h3 id="laptopmode">laptop_mode</h3>

<p><a href="http://www.samwel.tk/laptop_mode/">laptop_mode</a> is about:</p>

<blockquote>
  <p>Laptop mode is a kernel “mode” that allows you to extend the battery life of
your laptop. It does this by making disk write activity “bursty”, so that only
reads of uncached data result in a disk spinup. It causes a significant
improvement in battery life (for usage patterns that allow it).</p>
</blockquote>

<p>There are configuration files for it, but I did not try to use them.</p>

<h3 id="powertop">powertop</h3>

<p><a href="https://01.org/powertop">powertop</a> is from Intel. It could tune a number of
options to save power usage. For details, refer to
<a href="https://wiki.archlinux.org/index.php/Powertop">here</a>. I will only note down
normal usage scenario.</p>

<p>After first installation, we need to run:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>sudo powertop --calibrate
</code></pre>
</div>

<p>It will take several minutes to finish, and the screen could be dark for tens
of seconds. So do not panic when this happens. Also, do not touch your laptop
when powertop is calibrating. After this, you could get power consumption in
Watt and estimated remaining time in <code class="highlighter-rouge">powertop</code>. If you skip this, <code class="highlighter-rouge">powertop</code>
will still work, but not those two information.</p>

<p>Start <code class="highlighter-rouge">powertop</code>, in the <code class="highlighter-rouge">tunable</code> tab, you could see a number of tunable
options to improve your battery time. Make all the “Bad” to “Good” will save a
lot of power consumption. However, the change is lost after you reboot. To make
it permanent, do the following.</p>

<p>Run,</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>sudo powertop --html
</code></pre>
</div>

<p>You will get a html version report under current directory. Go to the tunable
page, you could see the command to tune, similar with the following:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="c"># Those following are the settings from powertop to save power.</span>
<span class="nb">echo</span> <span class="s1">'1500'</span> &gt; <span class="s1">'/proc/sys/vm/dirty_writeback_centisecs'</span>;
<span class="nb">echo</span> <span class="s1">'0'</span> &gt; <span class="s1">'/proc/sys/kernel/nmi_watchdog'</span>;
<span class="nb">echo</span> <span class="s1">'min_power'</span> &gt; <span class="s1">'/sys/class/scsi_host/host1/link_power_management_policy'</span>;
<span class="nb">echo</span> <span class="s1">'min_power'</span> &gt; <span class="s1">'/sys/class/scsi_host/host2/link_power_management_policy'</span>;
<span class="nb">echo</span> <span class="s1">'min_power'</span> &gt; <span class="s1">'/sys/class/scsi_host/host0/link_power_management_policy'</span>;
<span class="nb">echo</span> <span class="s1">'auto'</span> &gt; <span class="s1">'/sys/bus/usb/devices/1-6/power/control'</span>;
<span class="nb">echo</span> <span class="s1">'auto'</span> &gt; <span class="s1">'/sys/bus/pci/devices/0000:00:16.0/power/control'</span>;
<span class="nb">echo</span> <span class="s1">'auto'</span> &gt; <span class="s1">'/sys/bus/pci/devices/0000:02:00.0/power/control'</span>;
<span class="nb">echo</span> <span class="s1">'auto'</span> &gt; <span class="s1">'/sys/bus/pci/devices/0000:00:1f.3/power/control'</span>;
<span class="nb">echo</span> <span class="s1">'auto'</span> &gt; <span class="s1">'/sys/bus/pci/devices/0000:00:1f.2/power/control'</span>;
<span class="nb">echo</span> <span class="s1">'auto'</span> &gt; <span class="s1">'/sys/bus/pci/devices/0000:00:1f.6/power/control'</span>;
<span class="nb">echo</span> <span class="s1">'auto'</span> &gt; <span class="s1">'/sys/bus/pci/devices/0000:00:1f.0/power/control'</span>;
<span class="nb">echo</span> <span class="s1">'auto'</span> &gt; <span class="s1">'/sys/bus/pci/devices/0000:00:1d.0/power/control'</span>;
<span class="nb">echo</span> <span class="s1">'auto'</span> &gt; <span class="s1">'/sys/bus/pci/devices/0000:00:1c.1/power/control'</span>;
<span class="nb">echo</span> <span class="s1">'auto'</span> &gt; <span class="s1">'/sys/bus/pci/devices/0000:00:1c.0/power/control'</span>;
<span class="nb">echo</span> <span class="s1">'auto'</span> &gt; <span class="s1">'/sys/bus/pci/devices/0000:00:14.0/power/control'</span>;
<span class="nb">echo</span> <span class="s1">'auto'</span> &gt; <span class="s1">'/sys/bus/pci/devices/0000:00:02.0/power/control'</span>;
</code></pre>
</div>

<p>Copy all those lines, or only the ones you want to tune to <code class="highlighter-rouge">/etc/rc.local</code>,
then the change will be permanent.</p>

<h3 id="set-default-lightness">Set Default Lightness</h3>

<p>As least for me, no new packages are needed. Just put the following line in
<code class="highlighter-rouge">/etc/rc.local</code> is OK. Given the difference in hardwares, the <code class="highlighter-rouge">intel_backlight</code>
may be something else.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="c"># Set default brightness. The maximum value is 852. The value 350 here is hard tuned.</span>
<span class="nb">echo </span>350 &gt; /sys/class/backlight/intel_backlight/brightness
</code></pre>
</div>

<h2 id="extending-battery-life">Extending Battery Life</h2>

<p>I am delighted to find out that Thinkpad has such a good support for
Linux. Lenovo has a good mechanism to extend battery life on Windows. It will
stop charging the battery if the battery level has exceeded some threshold,
which would prolong the battery life given the properties of Lithium battery.</p>

<p>Thinkpad still support it if you are using Linux. The solution depends on the
hardware of your Thinkpad. If you are installing on a recent Thinkpad that has
an Ivy Bridge or newer processor (X230, T430, T530, etc.), like me, you could
use a utility named <a href="http://www.thinkwiki.org/wiki/Tpacpi-bat">tpacpi-bat</a>.</p>

<p>If you are using an old Thinkpad, go
<a href="http://www.thinkwiki.org/wiki/Tp_smapi">there</a> for a solution.</p>

<h3 id="install-acpi-call">Install <code class="highlighter-rouge">acpi-call</code></h3>

<p>I use Ubuntu 14.04, so the procedure to install <code class="highlighter-rouge">tpacpi-bat</code> on Ubuntu will be
described.</p>

<p><code class="highlighter-rouge">tpacpi-bat</code> has a <a href="https://launchpad.net/~morgwai/+archive/ubuntu/tpbat">ppa</a>
for Debian based system. Just add the ppa to your source:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>sudo sudo add-apt-repository PPA_NAME
</code></pre>
</div>

<p><code class="highlighter-rouge">tpacpi-bat</code> depends on <code class="highlighter-rouge">acpi-call</code>, which is part of <code class="highlighter-rouge">acpi-call-dkms</code>. So we
need to install <code class="highlighter-rouge">acpi-call-dkms</code> first. It is also part of the ppa.</p>

<p>The main reason that I write this note is that the package has a bug. This bug
is widely
<a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=762281">discovered</a> almost
one year ago, it is strange why it is not fixed yet. After setting up the ppa,
first try installing <code class="highlighter-rouge">acpi-call-dkms</code>.</p>

<p>The installation will fail with message similar with the following:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>make <span class="nv">KERNELRELEASE</span><span class="o">=</span>3.19.0-26-generic <span class="nv">KVERSION</span><span class="o">=</span>3.19.0-26-generic <span class="nv">KDIR</span><span class="o">=</span>/lib/modules/3.19.0-26-generic/build....<span class="o">(</span>bad <span class="nb">exit </span>status: 2<span class="o">)</span>
Error! Bad <span class="k">return </span>status <span class="k">for </span>module build on kernel: 3.19.0-26-generic <span class="o">(</span>x86_64<span class="o">)</span>
Consult /var/lib/dkms/acpi_call/1.1.0/build/make.log <span class="k">for </span>more information.
dpkg: error processing package acpi-call-dkms <span class="o">(</span>--configure<span class="o">)</span>:
</code></pre>
</div>

<p>Have a check at the <code class="highlighter-rouge">make.log</code>, the compilation error is:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>Please don<span class="s1">'t include &lt;acpi/acpi.h&gt; directly, include &lt;linux/acpi.h&gt; instead
</span></code></pre>
</div>

<p>So I go to <code class="highlighter-rouge">/var/lib/dkms/acpi_call/1.1.0/source/acpi_call.c</code>, where the
installer unpacks the source. I changed <code class="highlighter-rouge">&lt;acpi/acpi.h&gt;</code> to <code class="highlighter-rouge">&lt;linux/acpi.h&gt;</code>,
then try the installation(wit the same command) again. Wow, the compilation
passed and the installation is successful.</p>

<h3 id="install-tpacpi-bat">Install <code class="highlighter-rouge">tpacpi-bat</code></h3>

<p>This step is easy, just normal apt installation.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>sudo apt-get install tpacpi-bat
</code></pre>
</div>

<h3 id="configuration">Configuration</h3>

<p>After installation, now we need to configure the charge threshold of our
battery. The help message of <code class="highlighter-rouge">tpacpi-bat</code> does not seem to be very clear for
me. So I will note down how to get and set charging battery thresholds.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="c"># tpacpi-bat get start-threshold primary-battery</span>
tpacpi-bat   -g   ST             1
</code></pre>
</div>

<p>Thinkpad has one primary battery and one secondary battery. 1 stands for
primary battery and 2 stands for secondary battery.</p>

<p>To set the start threshold for starting charging:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="c"># tpacpi-bat set start-threshold primary-battery   start-threshold</span>
tpacpi-bat   -s  ST              1                 40 
</code></pre>
</div>

<p>It means the battery won’t charge if the its battery level is higher than 40.</p>

<p>To make the change permanent, add the following lines in <code class="highlighter-rouge">/etc/rc.local</code>.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="c"># Primary battery</span>
tpacpi-bat -s ST 1 40 <span class="c"># Start threshold</span>
tpacpi-bat -s SP 1 80 <span class="c"># Stop threshold</span>
<span class="c"># Secondary battery</span>
tpacpi-bat -s ST 2 40
tpacpi-bat -s SP 2 80
</code></pre>
</div>

  </div>

</article>

    </section>

    
    <div class="container">
      <section>
        <h1>Comments</h1>
        <div id="disqus_thread" aria-live="polite"><script type="text/javascript">
      var disqus_shortname = 'nautilus-shell-of-hhiker';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://shawnLeeZX.github.io/blog/2015/09/07/on-linux-laptop-battery/';
        var disqus_url = 'http://shawnLeeZX.github.io/blog/2015/09/07/on-linux-laptop-battery/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
      </section>
    </div>
    

    <!-- <nav class="navbar navbar-default navbar-fixed-bottom"> -->
<!-- <div class="container footer-content"> -->
    <!-- Nothing is there. -->
<!-- </div> -->
<!-- </nav> -->
  </body>

</html>
